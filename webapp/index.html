<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <link href="./css/bootstrap.min.css" rel="stylesheet">
        <style>
            body {
                padding-top:60px;
                background:url(./img/bg.gif);
            }
            .player-card {
                background:url(./img/playerbg.gif);
                color:#000;
            }
            .judge-card {
                background:url(./img/judgebg.gif);
                color:#fff;
                margin:0px auto;
            }
            .card {
                border:2px solid #333;
                height:250px;
                width:179px;
                padding:10px;
                font-weight:bold;
                -webkit-border-radius: 10px;
                -moz-border-radius: 10px;
                -webkit-box-shadow:  0px 0px 5px 1px rgba(0, 0, 0, .5);
                box-shadow:  0px 0px 5px 1px rgba(0, 0, 0, .5);
                -webkit-font-smoothing:subpixel-antialiased;
                border-radius: 10px;
            }
            .mid {
                text-align:center;
            }
            #discard div {
                -webkit-box-shadow:  0px 0px 5px 1px rgba(0, 0, 0, .5);
                box-shadow:  0px 0px 5px 1px rgba(0, 0, 0, .5);
                position:absolute;
            }
        </style>
        <link href="./css/bootstrap-responsive.css" rel="stylesheet">
        <script type="text/javascript" src="./js/jquery.js"></script>
        <script type="text/javascript" src="./js/jquery.tmpl.min.js"></script>
        <script type="text/javascript" src="./js/jquery-bbq.min.js"></script>
        <script type="text/javascript" src="./js/seedrandom.js"></script>
        <script>
            // Connect to Web Socket Game Coordinator and Facilitator
            var socket;
            var clientId;
            var clientName;
            var roomId;
            var activeUsers = [];
            var owner = false;
            var judge = false;
            
            function startGame() {
                clientName = "guest" + ~~(playerToken*10000);
                try {
                    var host = "ws://localhost:9876";
                    socket = new WebSocket(host);
                    message('{"clientAction":"Connecting..."}');
                    socket.onopen = function() {
                        message('{"clientAction":"Connected"}');
                    }
                    socket.onmessage = function(msg) {
                        message(msg.data);
                        data = JSON.parse(msg.data);
                        switch (data.action) {
                            case "register":
                                clientId = data.clientId;
                                if ($.bbq.getState("roomId")) {
                                    joinRoom($.bbq.getState("roomId"));
                                }
                            break;
                            case "gameJoined":
                                owner = data.gameState.owner == clientId;
                                shuffleSeed = data.gameState.options.seed;
                                cardsInHand = data.gameState.options.cardsInHand;
                                roomId = data.roomId;
                                $('#shareLink').attr('href','./index.html#roomId=' + data.roomId).html("Invitation Link");
                                Math.seedrandom(shuffleSeed);
                                playCards = [];
                                judgeCards = [];
                                for (var x=0; x<data.gameState.decks.white.length; x+=1) {
                                    playCards.push(data.gameState.decks.white[x]);
                                }
                                for (var x=0; x<data.gameState.decks.black.length; x+=1) {
                                    judgeCards.push(data.gameState.decks.black[x]);
                                }
                                for (var x=0; x<data.gameState.options.seedAdvance; x+=1) {
                                    Math.random();
                                }
                                for (var x=0; x<cardsInHand; x+=1) {
                                    requestDrawCard();
                                }
                                if (owner) {
                                    $("#adminPanel").tmpl({'start':'','stop':'disabled'}).appendTo('#wells')
                                }
                            break;
                            case "playerJoined":
                                activeUsers = data.gameState.users;
                                reDrawScoreboard();
                            break;
                            case "newJudgeCard":
                                newJudgeCard();
                                if (data.judge == clientId) {
                                    $('#playableCards').html("<div id='notify' class='alert alert-success'><button type='button' class='close' data-dismiss='alert' onclick='$(\"#notify\").remove()'>x</button><center>You are now the Judge!</center></div>");
                                }
                            break;
                            case "drawCard":
                                drawnCard(drawCard(),"white");
                            break;
                            case "discardCard":
                                drawCard(false);
                            break;
                            case "playCard":
                                discardCard(-1);
                            break;
                            case "playerChoice":
                                addChoice(data.card);
                            break;
                            case "sync":
                            break;
                            default:
                                message('{"clientAction":"Unknown Command"}');
                        }

                    }
                    socket.onclose = function() {
                        message('{"clientAction":"Closed"}');
                        setTimeout("startGame()",15000);
                    }
                } catch(exception) {
                    message('{"clientAction":"Error Connecting: ' + exception + '"}');
                }
            }

            function joinRoom(id) {
                var request = {};
                request.action = "join";
                request.room = id;
                request.clientId = clientId;
                request.clientName = clientName;
                socket.send(JSON.stringify(request));
            }

            function createRoom() {
                var request = {};
                request.action = "createRoom";
                request.clientId = clientId;
                request.clientName = clientName;
                socket.send(JSON.stringify(request));
            }

            function requestDrawCard() {
                var request = {};
                request.action = "requestDrawCard";
                request.room = roomId;
                request.clientId = clientId;
                request.clientName = clientName;
                socket.send(JSON.stringify(request));
            }

            function drawnCard(cardId,type) {
                var request = {};
                request.action = "drawnCard";
                request.room = roomId;
                request.clientId = clientId;
                request.clientName = clientName;
                request.card = cardId;
                request.type = type;
                socket.send(JSON.stringify(request));
            }
            function sendCardToJudge(cardId) {
                var request = {};
                request.action = "sendToJudge";
                request.room = roomId;
                request.clientId = clientId;
                request.clientName = clientName;
                request.card = cardId;
                socket.send(JSON.stringify(request));
            }

            function adminStartGame() {
                if ($("#adminStartGame").attr('disabled') == undefined) {
                    var request = {};
                    request.action = "startGame";
                    request.room = roomId;
                    request.clientId = clientId;
                    request.clientName = clientName;
                    socket.send(JSON.stringify(request));
                }
            }
            
            function adminStopGame() {
                if ($("#adminStartGame").attr('disabled') == undefined) {
                    var request = {};
                    request.action = "stopGame";
                    request.room = roomId;
                    request.clientId = clientId;
                    request.clientName = clientName;
                    socket.send(JSON.stringify(request));
                }
            }
            
            function message(msg) {
                console.log(JSON.parse(msg));
            }

        </script>
        <script>
            var judgeCards = [];
            var playCards = [];
            var allPlay = [];
            var allJudge = [];
            var discard = [];
            var currentHand = [];
            var awesomePoints = [];
            var playerToken = Math.random()*100;
            var shuffleSeed;
            var canPlay = false;
            var cardsPlayed = 0;
            var howMany = 0;
            var cardsInHand;

            $(document).ready(function() {
                Math.seedrandom(shuffleSeed);
                loadCards();
            });
            function loadCards() {
                $.ajax({
                    type:"GET",
                    url:"./cards.json",
                    dataType:"json",
                    timeout:25000,
                    success: function(data) {
                        allPlay = data.white;
                        allJudge = data.black;
                        startGame()
                    },
                    error: function() {
                        console.log("Error!");
                    }
                });
            }

            function addChoice(cardId) {
                var cardInfo = {
                    "rotate":0,
                    "leftpad":0,
                    "toppad":0,
                    "text":allPlay[cardId],
                    "type":"player",
                    "cardNum":0,
                    "disabled":""
                }
                $("#playerCard").tmpl(cardInfo).appendTo("#playableCards");

            }

            function newJudgeCard() {
                var nextCard = Math.ceil(Math.random()*judgeCards.length)-1;
                $("#judge").html("");
                $("#discard").html("");
                canPlay = true;
                cardsPlayed = 0;
                howMany = allJudge[judgeCards[nextCard]].match(/_/g).length;
                var cardinfo = {"text":allJudge[judgeCards[nextCard]].replace(/_/g,'____________________')};
                $("#judgeCard").tmpl(cardinfo).appendTo("#judge");
                console.log(cardinfo);
                judgeCards.splice(nextCard,1);
                discardCard();
                reDrawHand();
            }

            function drawCard(inHand) {
                if (inHand == undefined)
                    inHand = true;
                var nextCard = Math.ceil(Math.random()*playCards.length)-1;
                if (inHand) {
                    if (currentHand.length < cardsInHand) {
                        currentHand.push(playCards[nextCard]);
                        playCards.splice(nextCard,1);
                    } else if (currentHand >= cardsInHand) {
                        console.log("Hand is full.");
                    }
                } else {
                    discard.push(playCards[nextCard]);
                    playCards.splice(nextCard,1);
                }
                reDrawHand();
                return nextCard;
            }
            
            function reDrawHand() {
                $('#playableCards').html("");
                var disabled = "disabled";
                if (canPlay)
                    disabled = "";
                for (var x=0; x<currentHand.length; x+=1) {
                    if (currentHand[x] == undefined)
                        disabled = "disabled"
                    var cardInfo = {
                        "rotate":0,
                        "leftpad":0,
                        "toppad":0,
                        "text":allPlay[currentHand[x]],
                        "type":"player",
                        "cardNum":x,
                        "disabled":disabled
                    }
                    $("#playerCard").tmpl(cardInfo).appendTo("#playableCards");
                }
            }

            function reDrawScoreboard() {
                $('#leaders').html("");
                for (var x=0; x<activeUsers.length; x+=1) {
                    var cardInfo = {'name':activeUsers[x]['name'],'score':activeUsers[x]['score']}
                    $("#score").tmpl(cardInfo).appendTo("#leaders");
                }
            }

            function discardCard(index) {
                if (index == undefined) {
                    type = "judge";
                } else {
                    if (index >= 0 && index < cardsInHand) {
                        cardsPlayed += 1;
                        if (cardsPlayed >= howMany)
                            canPlay = false;
                        discard.push(currentHand[index]);
                        
                        sendCardToJudge(currentHand[index]);
                        
                        currentHand.splice(index,1);
                        
                    }
                    type = "player";
                }
                cardInfo = {
                    "rotate":~~(rotationValue()*50-25),
                    "leftpad":~~(rotationValue(12342142134)*100),
                    "toppad":~~(rotationValue(5649813156)*40+25),
                    "text":"Cards Against Humanity",
                    "type":type
                }
                $("#discardCard").tmpl(cardInfo).appendTo("#discard");
            }

            function rotationValue(seed) {
                if (seed == undefined)
                    seed = 712323412;
                return new Date()*seed%100000/100000;
            }
        </script>

        <script id='playerCard' type="text/x-jquery-tmpl">
            <button class="btn btn-large btn-block" type="button" ${disabled} onclick="discardCard(${cardNum})">${text}</button> 
        </script>
        
        <script id='winnerCard' type="text/x-jquery-tmpl">
            <div class="card player-card">
                <b>${text}</b>
            </div>
        </script>

        <script id='score' type="text/x-jquery-tmpl">
            <tr>
                <td>${name}</td>
                <td>${score}</td>
            </tr>
        </script>
        
        <script id='judgeCard' type="text/x-jquery-tmpl">
            <div class="card judge-card">
                <b>${text}</b>
            </div>
        </script>
        
        <script id='discardCard' type="text/x-jquery-tmpl">
            <div class="card ${type}-card visible-desktop" style="margin-left:${leftpad}px;margin-top:${toppad}px;-webkit-transform: rotate(${rotate}deg);-moz-transform: rotate(${rotate}deg);font-size:42px;line-height:115%;">
                <b>Cards<br>of<br>Lunacy</b>
            </div>
        </script>

        <script id="adminPanel" type="text/x-jquery-tmpl">
            <div class="well">
                <h4>Admin Panel</h4>
                <center>
                    <button id="adminStartGame" onclick="adminStartGame()" class="btn btn-success btn-mini ${start}">Start Game</button>
                    <button id="adminStopGame" onclick="adminStopGame()" class="btn btn-danger btn-mini ${stop}">Stop Game</button>
                </center>
            </div>
        </script>
    </head>
    
    <body>
        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a href="#" class="brand">Cards of Lunacy</a>
                    <ul class="nav pull-right">
                        <li>
                            <a href="#">Help <i class="icon-question-sign icon-white"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="span4">
                <div id="judge"></div>
                <div id="discard"></div>
            </div>


            <div class="span4">
                <div id="playableCards"></div>
            </div>

            <div class="span3" id="wells">
                <div class="well">
                    <h4>Leaderboard</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody id="leaders">
                            
                        </tbody>
                    </table>
                </div>
                <div class="well">
                    <div id="newGame">
                        <center>
                            <div class="form-inline">
                                Name: <input type="text" class="input-small" id="clientName" />
                            </div><br>
                            <button class="btn btn-inverse btn-mini" onclick="createRoom()">New Room</button>
                            <button class="btn btn-inverse btn-mini">Join Game</button><br>
                            <a id="shareLink"></a>
                        </center>
                    </div>
                </div>
            </div>
        </div>
        <div class="navbar navbar-inverse navbar-fixed-bottom">
            <div class="navbar-inner">
                <div class="container">
                    <ul class="nav pull-right">
                        <li>
                            <a href="http://www.cardsagainsthumanity.com">Based off of <u>Cards Against Humanity(tm)</u></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </body>
</html>
